name: Publish to Release Branch

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-release-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare release files
        run: |
          # Create a clean directory for release files
          mkdir -p release-files

          # Copy extension files
          cp index.js release-files/
          cp style.css release-files/
          cp settings.html release-files/
          cp manifest.json release-files/
          cp README.md release-files/
          cp LICENSE release-files/

          # Copy src files except tests
          mkdir -p release-files/src
          find src -type f -name "*.js" ! -path "*/__tests__/*" -exec cp {} release-files/src/ \;

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create/update release branch
        run: |
          # Save git remote info before cleanup
          git_remote=$(git remote get-url origin)
          
          # Remove all files except .git directory
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Copy release files to root
          cp -r release-files/* .
          rm -rf release-files

          # Ensure git remote is configured
          git remote add origin "$git_remote" 2>/dev/null || true

          # Create or switch to release branch
          git checkout release 2>/dev/null || git checkout --orphan release

          # Add all files
          git add -A

          # Commit with release tag name
          git commit -m "Release ${{ github.event.release.tag_name }}" || echo "No changes to commit"

          # Force push to release branch
          git push -f origin release
